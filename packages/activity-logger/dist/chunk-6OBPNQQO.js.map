{"version":3,"sources":["../src/arweave/irys-uploader.ts"],"sourcesContent":["import Irys from \"@irys/sdk\";\nimport { Keypair } from \"@solana/web3.js\";\nimport { createHash } from \"crypto\";\nimport type {\n  Activity,\n  ArweaveActivityRecord,\n  Decision,\n  Discovery,\n} from \"../types.js\";\n\nexport interface ArweaveUploaderConfig {\n  solanaRpcUrl: string;\n  solanaPrivateKey: string;\n  gatewayUrl?: string;\n  minPayloadSize?: number;\n}\n\nexport interface ArweaveUploadResult {\n  txId: string;\n  url: string;\n  size: number;\n  cost: number;\n}\n\nexport class ArweaveUploader {\n  private irys: Irys | null = null;\n  private config: ArweaveUploaderConfig;\n  private keypair: Keypair;\n  private initialized = false;\n\n  constructor(config: ArweaveUploaderConfig) {\n    this.config = config;\n    this.keypair = this.parsePrivateKey(config.solanaPrivateKey);\n  }\n\n  private parsePrivateKey(privateKey: string): Keypair {\n    try {\n      const parsed = JSON.parse(privateKey);\n      if (Array.isArray(parsed)) {\n        return Keypair.fromSecretKey(Uint8Array.from(parsed));\n      }\n    } catch {\n      // Not JSON\n    }\n\n    // Try base58\n    const bs58 = this.base58Decode(privateKey);\n    return Keypair.fromSecretKey(bs58);\n  }\n\n  private base58Decode(str: string): Uint8Array {\n    const ALPHABET =\n      \"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\";\n    const bytes: number[] = [];\n    for (const char of str) {\n      let carry = ALPHABET.indexOf(char);\n      if (carry === -1) throw new Error(\"Invalid base58 character\");\n      for (let j = 0; j < bytes.length; j++) {\n        carry += bytes[j] * 58;\n        bytes[j] = carry & 0xff;\n        carry >>= 8;\n      }\n      while (carry > 0) {\n        bytes.push(carry & 0xff);\n        carry >>= 8;\n      }\n    }\n    for (const char of str) {\n      if (char !== \"1\") break;\n      bytes.push(0);\n    }\n    return Uint8Array.from(bytes.reverse());\n  }\n\n  async initialize(): Promise<void> {\n    if (this.initialized) return;\n\n    this.irys = new Irys({\n      url: this.config.gatewayUrl ?? \"https://node1.irys.xyz\",\n      token: \"solana\",\n      key: this.keypair.secretKey,\n      config: {\n        providerUrl: this.config.solanaRpcUrl,\n      },\n    });\n\n    await this.irys.ready();\n    this.initialized = true;\n  }\n\n  async uploadActivity(\n    activity: Activity,\n    options?: {\n      discovery?: Discovery;\n      decision?: Decision;\n      solanaTxHash?: string;\n      solanaSlot?: number;\n    }\n  ): Promise<ArweaveUploadResult> {\n    await this.initialize();\n\n    const record = this.buildArweaveRecord(activity, options);\n    const data = JSON.stringify(record, null, 2);\n    const dataBuffer = Buffer.from(data);\n\n    const price = await this.irys!.getPrice(dataBuffer.length);\n\n    const receipt = await this.irys!.upload(dataBuffer, {\n      tags: [\n        { name: \"Content-Type\", value: \"application/json\" },\n        { name: \"App-Name\", value: \"gICM-Orchestrator\" },\n        { name: \"App-Version\", value: \"1.0.0\" },\n        { name: \"Activity-Type\", value: activity.type },\n        { name: \"Activity-ID\", value: activity.id },\n        { name: \"Content-Hash\", value: record.onChain.contentHash },\n        {\n          name: \"Created-At\",\n          value: activity.createdAt.toISOString(),\n        },\n      ],\n    });\n\n    return {\n      txId: receipt.id,\n      url: `https://arweave.net/${receipt.id}`,\n      size: dataBuffer.length,\n      cost: Number(price) / 1e12, // Convert to SOL\n    };\n  }\n\n  async uploadBatch(\n    activities: Array<{\n      activity: Activity;\n      discovery?: Discovery;\n      decision?: Decision;\n    }>\n  ): Promise<ArweaveUploadResult> {\n    await this.initialize();\n\n    const batch = {\n      \"@context\": \"https://gicm.dev/schemas/activity-batch/v1\",\n      \"@type\": \"OrchestratorActivityBatch\",\n      version: 1,\n      createdAt: new Date().toISOString(),\n      count: activities.length,\n      activities: activities.map(({ activity, discovery, decision }) =>\n        this.buildArweaveRecord(activity, { discovery, decision })\n      ),\n    };\n\n    const data = JSON.stringify(batch, null, 2);\n    const dataBuffer = Buffer.from(data);\n    const price = await this.irys!.getPrice(dataBuffer.length);\n\n    const receipt = await this.irys!.upload(dataBuffer, {\n      tags: [\n        { name: \"Content-Type\", value: \"application/json\" },\n        { name: \"App-Name\", value: \"gICM-Orchestrator\" },\n        { name: \"Batch-Type\", value: \"activities\" },\n        { name: \"Batch-Count\", value: String(activities.length) },\n        { name: \"Created-At\", value: new Date().toISOString() },\n      ],\n    });\n\n    return {\n      txId: receipt.id,\n      url: `https://arweave.net/${receipt.id}`,\n      size: dataBuffer.length,\n      cost: Number(price) / 1e12,\n    };\n  }\n\n  async getPrice(sizeBytes: number): Promise<number> {\n    await this.initialize();\n    const price = await this.irys!.getPrice(sizeBytes);\n    return Number(price) / 1e12;\n  }\n\n  async getBalance(): Promise<number> {\n    await this.initialize();\n    const balance = await this.irys!.getLoadedBalance();\n    return Number(balance) / 1e12;\n  }\n\n  async fund(amount: number): Promise<string> {\n    await this.initialize();\n    const fundTx = await this.irys!.fund(amount * 1e12);\n    return fundTx.id;\n  }\n\n  private buildArweaveRecord(\n    activity: Activity,\n    options?: {\n      discovery?: Discovery;\n      decision?: Decision;\n      solanaTxHash?: string;\n      solanaSlot?: number;\n    }\n  ): ArweaveActivityRecord {\n    const contentHash = this.computeHash(activity);\n\n    // Create signature (in production, this would be a proper ed25519 signature)\n    const signature = this.computeHash({\n      activity: activity.id,\n      timestamp: Date.now(),\n      key: this.keypair.publicKey.toBase58(),\n    });\n\n    return {\n      \"@context\": \"https://gicm.dev/schemas/activity/v1\",\n      \"@type\": \"OrchestratorActivity\",\n      id: activity.id,\n      version: 1,\n      orchestrator: {\n        id: \"gicm-orchestrator\",\n        version: \"1.0.0\",\n        owner: this.keypair.publicKey.toBase58(),\n      },\n      activity: {\n        type: activity.type,\n        status: activity.status,\n        priority: 0,\n        createdAt: activity.createdAt.toISOString(),\n        completedAt: activity.completedAt?.toISOString(),\n        input: activity.inputData,\n        output: activity.outputData,\n        reasoning: activity.reasoning,\n        confidence: activity.confidence,\n      },\n      relationships: {\n        parentId: activity.parentId,\n        workflowId: activity.workflowId,\n        agentId: activity.agentId,\n        discoveryId: options?.discovery?.id,\n        decisionId: options?.decision?.id,\n      },\n      onChain: {\n        solanaTx: options?.solanaTxHash ?? activity.solanaTxHash,\n        solanaSlot: options?.solanaSlot,\n        contentHash,\n      },\n      discovery: options?.discovery,\n      decision: options?.decision,\n      signature: {\n        algorithm: \"ed25519\",\n        publicKey: this.keypair.publicKey.toBase58(),\n        value: signature,\n      },\n    };\n  }\n\n  private computeHash(data: unknown): string {\n    return createHash(\"sha256\").update(JSON.stringify(data)).digest(\"hex\");\n  }\n}\n\n// Helper to verify an Arweave record\nexport async function verifyArweaveRecord(\n  txId: string,\n  expectedHash: string,\n  gatewayUrl: string = \"https://arweave.net\"\n): Promise<{ verified: boolean; record?: ArweaveActivityRecord }> {\n  try {\n    const response = await fetch(`${gatewayUrl}/${txId}`);\n    if (!response.ok) {\n      return { verified: false };\n    }\n\n    const record = (await response.json()) as ArweaveActivityRecord;\n    const verified = record.onChain.contentHash === expectedHash;\n\n    return { verified, record };\n  } catch {\n    return { verified: false };\n  }\n}\n"],"mappings":"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","names":[]}