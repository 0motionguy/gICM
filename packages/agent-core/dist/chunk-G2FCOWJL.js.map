{"version":3,"sources":["../src/observability/log-aggregator.ts"],"sourcesContent":["/**\n * Log Aggregator (Phase 14B)\n *\n * Centralized logging with structured output, log levels, and context enrichment.\n * Supports multiple transports (console, file, HTTP) and log correlation with traces.\n */\n\nimport { trace, context as otelContext } from '@opentelemetry/api';\nimport { existsSync, mkdirSync, appendFileSync } from 'fs';\nimport { join } from 'path';\n\nexport type LogLevel = 'debug' | 'info' | 'warn' | 'error' | 'fatal';\n\nexport interface LogEntry {\n  timestamp: string;\n  level: LogLevel;\n  message: string;\n  serviceName: string;\n  traceId?: string;\n  spanId?: string;\n  context?: Record<string, any>;\n  error?: {\n    name: string;\n    message: string;\n    stack?: string;\n  };\n}\n\nexport interface LogTransport {\n  name: string;\n  log(entry: LogEntry): void | Promise<void>;\n}\n\nexport interface LogAggregatorConfig {\n  serviceName: string;\n  minLevel?: LogLevel;\n  transports?: LogTransport[];\n  enableTraceCorrelation?: boolean;\n  enableConsole?: boolean;\n  enableFile?: boolean;\n  logDirectory?: string;\n  contextEnricher?: (entry: LogEntry) => LogEntry;\n}\n\nconst LOG_LEVELS: Record<LogLevel, number> = {\n  debug: 0,\n  info: 1,\n  warn: 2,\n  error: 3,\n  fatal: 4,\n};\n\nconst LOG_COLORS: Record<LogLevel, string> = {\n  debug: '\\x1b[36m', // Cyan\n  info: '\\x1b[32m',  // Green\n  warn: '\\x1b[33m',  // Yellow\n  error: '\\x1b[31m', // Red\n  fatal: '\\x1b[35m', // Magenta\n};\n\nconst RESET_COLOR = '\\x1b[0m';\n\n/**\n * Console Transport\n */\nexport class ConsoleTransport implements LogTransport {\n  name = 'console';\n\n  log(entry: LogEntry): void {\n    const color = LOG_COLORS[entry.level];\n    const prefix = `${color}[${entry.level.toUpperCase()}]${RESET_COLOR}`;\n    const timestamp = new Date(entry.timestamp).toISOString();\n\n    let message = `${prefix} ${timestamp} [${entry.serviceName}] ${entry.message}`;\n\n    if (entry.traceId) {\n      message += ` (trace: ${entry.traceId})`;\n    }\n\n    if (entry.context && Object.keys(entry.context).length > 0) {\n      message += `\\n  Context: ${JSON.stringify(entry.context, null, 2)}`;\n    }\n\n    if (entry.error) {\n      message += `\\n  Error: ${entry.error.name}: ${entry.error.message}`;\n      if (entry.error.stack) {\n        message += `\\n${entry.error.stack}`;\n      }\n    }\n\n    console.log(message);\n  }\n}\n\n/**\n * File Transport\n */\nexport class FileTransport implements LogTransport {\n  name = 'file';\n  private logDirectory: string;\n  private logFile: string;\n\n  constructor(logDirectory: string) {\n    this.logDirectory = logDirectory;\n\n    // Create log directory if it doesn't exist\n    if (!existsSync(logDirectory)) {\n      mkdirSync(logDirectory, { recursive: true });\n    }\n\n    // Create daily log file\n    const date = new Date().toISOString().split('T')[0];\n    this.logFile = join(logDirectory, `app-${date}.log`);\n  }\n\n  log(entry: LogEntry): void {\n    const line = JSON.stringify(entry) + '\\n';\n    appendFileSync(this.logFile, line, 'utf-8');\n  }\n}\n\n/**\n * HTTP Transport (for log aggregation services like Grafana Loki)\n */\nexport class HttpTransport implements LogTransport {\n  name = 'http';\n  private endpoint: string;\n  private batchSize: number;\n  private batch: LogEntry[] = [];\n  private flushInterval: NodeJS.Timeout;\n\n  constructor(endpoint: string, batchSize = 100, flushIntervalMs = 5000) {\n    this.endpoint = endpoint;\n    this.batchSize = batchSize;\n\n    // Auto-flush on interval\n    this.flushInterval = setInterval(() => {\n      this.flush();\n    }, flushIntervalMs);\n  }\n\n  log(entry: LogEntry): void {\n    this.batch.push(entry);\n\n    if (this.batch.length >= this.batchSize) {\n      this.flush();\n    }\n  }\n\n  async flush(): Promise<void> {\n    if (this.batch.length === 0) return;\n\n    const logs = [...this.batch];\n    this.batch = [];\n\n    try {\n      await fetch(this.endpoint, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ logs }),\n      });\n    } catch (error) {\n      console.error('[HttpTransport] Failed to send logs:', error);\n      // Re-add to batch for retry\n      this.batch.unshift(...logs);\n    }\n  }\n\n  destroy(): void {\n    clearInterval(this.flushInterval);\n    this.flush();\n  }\n}\n\n/**\n * Log Aggregator\n */\nexport class LogAggregator {\n  private config: Required<LogAggregatorConfig>;\n  private transports: LogTransport[] = [];\n\n  constructor(config: LogAggregatorConfig) {\n    this.config = {\n      minLevel: 'info',\n      transports: [],\n      enableTraceCorrelation: true,\n      enableConsole: true,\n      enableFile: false,\n      logDirectory: './logs',\n      contextEnricher: (entry) => entry,\n      ...config,\n    };\n\n    this.initializeTransports();\n  }\n\n  private initializeTransports(): void {\n    // Add default console transport\n    if (this.config.enableConsole) {\n      this.transports.push(new ConsoleTransport());\n    }\n\n    // Add file transport\n    if (this.config.enableFile) {\n      this.transports.push(new FileTransport(this.config.logDirectory));\n    }\n\n    // Add custom transports\n    this.transports.push(...this.config.transports);\n  }\n\n  /**\n   * Log a message\n   */\n  log(\n    level: LogLevel,\n    message: string,\n    context?: Record<string, any>,\n    error?: Error\n  ): void {\n    // Check min level\n    if (LOG_LEVELS[level] < LOG_LEVELS[this.config.minLevel]) {\n      return;\n    }\n\n    // Build log entry\n    let entry: LogEntry = {\n      timestamp: new Date().toISOString(),\n      level,\n      message,\n      serviceName: this.config.serviceName,\n      context,\n    };\n\n    // Add trace correlation\n    if (this.config.enableTraceCorrelation) {\n      const span = trace.getActiveSpan();\n      if (span) {\n        const spanContext = span.spanContext();\n        entry.traceId = spanContext.traceId;\n        entry.spanId = spanContext.spanId;\n      }\n    }\n\n    // Add error details\n    if (error) {\n      entry.error = {\n        name: error.name,\n        message: error.message,\n        stack: error.stack,\n      };\n    }\n\n    // Enrich with custom context\n    entry = this.config.contextEnricher(entry);\n\n    // Send to all transports\n    for (const transport of this.transports) {\n      try {\n        transport.log(entry);\n      } catch (err) {\n        console.error(`[LogAggregator] Transport ${transport.name} failed:`, err);\n      }\n    }\n  }\n\n  // Convenience methods\n  debug(message: string, context?: Record<string, any>): void {\n    this.log('debug', message, context);\n  }\n\n  info(message: string, context?: Record<string, any>): void {\n    this.log('info', message, context);\n  }\n\n  warn(message: string, context?: Record<string, any>): void {\n    this.log('warn', message, context);\n  }\n\n  error(message: string, errorOrContext?: Error | Record<string, any>, context?: Record<string, any>): void {\n    if (errorOrContext instanceof Error) {\n      this.log('error', message, context, errorOrContext);\n    } else {\n      this.log('error', message, errorOrContext);\n    }\n  }\n\n  fatal(message: string, errorOrContext?: Error | Record<string, any>, context?: Record<string, any>): void {\n    if (errorOrContext instanceof Error) {\n      this.log('fatal', message, context, errorOrContext);\n    } else {\n      this.log('fatal', message, errorOrContext);\n    }\n  }\n\n  /**\n   * Create a child logger with additional context\n   */\n  child(additionalContext: Record<string, any>): LogAggregator {\n    const childConfig = {\n      ...this.config,\n      contextEnricher: (entry: LogEntry) => {\n        const enriched = this.config.contextEnricher(entry);\n        return {\n          ...enriched,\n          context: { ...additionalContext, ...enriched.context },\n        };\n      },\n    };\n\n    return new LogAggregator(childConfig);\n  }\n\n  /**\n   * Add a new transport\n   */\n  addTransport(transport: LogTransport): void {\n    this.transports.push(transport);\n  }\n\n  /**\n   * Remove a transport by name\n   */\n  removeTransport(name: string): void {\n    this.transports = this.transports.filter(t => t.name !== name);\n  }\n\n  /**\n   * Get all transports\n   */\n  getTransports(): LogTransport[] {\n    return [...this.transports];\n  }\n\n  /**\n   * Flush all transports (for HTTP transports with buffering)\n   */\n  async flush(): Promise<void> {\n    for (const transport of this.transports) {\n      if (transport instanceof HttpTransport) {\n        await transport.flush();\n      }\n    }\n  }\n\n  /**\n   * Destroy all transports and clean up\n   */\n  destroy(): void {\n    for (const transport of this.transports) {\n      if (transport instanceof HttpTransport) {\n        transport.destroy();\n      }\n    }\n  }\n}\n\n/**\n * Global logger instance (singleton pattern)\n */\nlet globalLogger: LogAggregator | null = null;\n\nexport function initializeLogger(config: LogAggregatorConfig): LogAggregator {\n  if (globalLogger) {\n    console.warn('[LogAggregator] Global logger already exists');\n    return globalLogger;\n  }\n\n  globalLogger = new LogAggregator(config);\n  return globalLogger;\n}\n\nexport function getLogger(): LogAggregator {\n  if (!globalLogger) {\n    // Create a default logger if none exists\n    globalLogger = new LogAggregator({\n      serviceName: 'default',\n      minLevel: 'info',\n    });\n  }\n  return globalLogger;\n}\n\nexport function destroyLogger(): void {\n  if (globalLogger) {\n    globalLogger.destroy();\n    globalLogger = null;\n  }\n}\n"],"mappings":"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","names":[]}