{"version":3,"sources":["../src/observability/slo-manager.ts"],"sourcesContent":["/**\n * SLO Manager (Phase 14D)\n *\n * Service Level Objective (SLO) tracking and alerting.\n * Monitors availability, latency, error rate, and custom SLOs.\n * Calculates error budgets and triggers alerts when SLOs are at risk.\n */\n\nimport { getMetricsRegistry, type MetricsRegistry } from './metrics-registry.js';\nimport { getLogger, type LogAggregator } from './log-aggregator.js';\n\nexport interface SLO {\n  id: string;\n  name: string;\n  description: string;\n  target: number; // Target percentage (0-100)\n  window: number; // Time window in seconds\n  metricQuery: (registry: MetricsRegistry) => Promise<number>;\n}\n\nexport interface SLOStatus {\n  slo: SLO;\n  current: number; // Current percentage (0-100)\n  target: number; // Target percentage (0-100)\n  errorBudget: number; // Remaining error budget (0-100)\n  state: 'healthy' | 'warning' | 'critical';\n  lastEvaluated: Date;\n}\n\nexport interface SLOAlert {\n  sloId: string;\n  sloName: string;\n  severity: 'warning' | 'critical';\n  message: string;\n  current: number;\n  target: number;\n  errorBudget: number;\n  timestamp: Date;\n}\n\nexport interface SLOManagerConfig {\n  serviceName: string;\n  evaluationInterval?: number; // Seconds between evaluations\n  warningThreshold?: number; // % of error budget remaining to trigger warning\n  criticalThreshold?: number; // % of error budget remaining to trigger critical\n  alertCallback?: (alert: SLOAlert) => void | Promise<void>;\n  metricsRegistry?: MetricsRegistry;\n  logger?: LogAggregator;\n}\n\nconst DEFAULT_CONFIG: Partial<SLOManagerConfig> = {\n  evaluationInterval: 60, // 1 minute\n  warningThreshold: 20, // Warning at 20% error budget remaining\n  criticalThreshold: 5, // Critical at 5% error budget remaining\n};\n\n/**\n * SLO Manager\n */\nexport class SLOManager {\n  private config: Required<SLOManagerConfig>;\n  private slos = new Map<string, SLO>();\n  private statuses = new Map<string, SLOStatus>();\n  private evaluationInterval: NodeJS.Timeout | null = null;\n  private running = false;\n\n  constructor(config: SLOManagerConfig) {\n    this.config = {\n      ...DEFAULT_CONFIG,\n      ...config,\n      metricsRegistry: config.metricsRegistry || getMetricsRegistry(),\n      logger: config.logger || getLogger(),\n      alertCallback: config.alertCallback || this.defaultAlertCallback.bind(this),\n    } as Required<SLOManagerConfig>;\n  }\n\n  /**\n   * Register an SLO\n   */\n  registerSLO(slo: SLO): void {\n    if (this.slos.has(slo.id)) {\n      this.config.logger.warn(`SLO ${slo.id} already registered, overwriting`);\n    }\n\n    this.slos.set(slo.id, slo);\n    this.config.logger.info(`Registered SLO: ${slo.name} (target: ${slo.target}%)`);\n  }\n\n  /**\n   * Unregister an SLO\n   */\n  unregisterSLO(sloId: string): void {\n    this.slos.delete(sloId);\n    this.statuses.delete(sloId);\n    this.config.logger.info(`Unregistered SLO: ${sloId}`);\n  }\n\n  /**\n   * Get all registered SLOs\n   */\n  getSLOs(): SLO[] {\n    return Array.from(this.slos.values());\n  }\n\n  /**\n   * Get SLO status\n   */\n  getStatus(sloId: string): SLOStatus | undefined {\n    return this.statuses.get(sloId);\n  }\n\n  /**\n   * Get all SLO statuses\n   */\n  getAllStatuses(): SLOStatus[] {\n    return Array.from(this.statuses.values());\n  }\n\n  /**\n   * Start periodic SLO evaluation\n   */\n  start(): void {\n    if (this.running) {\n      this.config.logger.warn('SLO Manager already running');\n      return;\n    }\n\n    this.running = true;\n    this.config.logger.info(`Starting SLO Manager (interval: ${this.config.evaluationInterval}s)`);\n\n    // Initial evaluation\n    this.evaluateAll();\n\n    // Periodic evaluation\n    this.evaluationInterval = setInterval(() => {\n      this.evaluateAll();\n    }, this.config.evaluationInterval * 1000);\n  }\n\n  /**\n   * Stop periodic SLO evaluation\n   */\n  stop(): void {\n    if (!this.running) {\n      return;\n    }\n\n    this.running = false;\n    if (this.evaluationInterval) {\n      clearInterval(this.evaluationInterval);\n      this.evaluationInterval = null;\n    }\n\n    this.config.logger.info('SLO Manager stopped');\n  }\n\n  /**\n   * Evaluate all SLOs\n   */\n  async evaluateAll(): Promise<void> {\n    const promises = Array.from(this.slos.values()).map(slo => this.evaluateSLO(slo));\n    await Promise.allSettled(promises);\n  }\n\n  /**\n   * Evaluate a single SLO\n   */\n  async evaluateSLO(slo: SLO): Promise<SLOStatus> {\n    try {\n      const current = await slo.metricQuery(this.config.metricsRegistry);\n      const errorBudget = this.calculateErrorBudget(current, slo.target);\n      const state = this.determineState(errorBudget);\n\n      const status: SLOStatus = {\n        slo,\n        current,\n        target: slo.target,\n        errorBudget,\n        state,\n        lastEvaluated: new Date(),\n      };\n\n      // Check previous status for state changes\n      const previousStatus = this.statuses.get(slo.id);\n      if (previousStatus && previousStatus.state !== state) {\n        await this.handleStateChange(previousStatus, status);\n      }\n\n      // Update status\n      this.statuses.set(slo.id, status);\n\n      // Log status\n      this.config.logger.debug(`SLO ${slo.name}: ${current.toFixed(2)}% (target: ${slo.target}%, budget: ${errorBudget.toFixed(2)}%)`, {\n        sloId: slo.id,\n        current,\n        target: slo.target,\n        errorBudget,\n        state,\n      });\n\n      return status;\n    } catch (error) {\n      this.config.logger.error(`Failed to evaluate SLO ${slo.name}`, error as Error);\n      throw error;\n    }\n  }\n\n  /**\n   * Calculate error budget\n   */\n  private calculateErrorBudget(current: number, target: number): number {\n    const allowedError = 100 - target;\n    const actualError = 100 - current;\n    const budgetUsed = (actualError / allowedError) * 100;\n    return Math.max(0, Math.min(100, 100 - budgetUsed));\n  }\n\n  /**\n   * Determine SLO state based on error budget\n   */\n  private determineState(errorBudget: number): 'healthy' | 'warning' | 'critical' {\n    if (errorBudget <= this.config.criticalThreshold) {\n      return 'critical';\n    } else if (errorBudget <= this.config.warningThreshold) {\n      return 'warning';\n    }\n    return 'healthy';\n  }\n\n  /**\n   * Handle state changes\n   */\n  private async handleStateChange(previous: SLOStatus, current: SLOStatus): Promise<void> {\n    this.config.logger.warn(\n      `SLO ${current.slo.name} state changed: ${previous.state} â†’ ${current.state}`,\n      {\n        sloId: current.slo.id,\n        previousState: previous.state,\n        currentState: current.state,\n        current: current.current,\n        target: current.target,\n        errorBudget: current.errorBudget,\n      }\n    );\n\n    // Trigger alert for warning or critical states\n    if (current.state === 'warning' || current.state === 'critical') {\n      const alert: SLOAlert = {\n        sloId: current.slo.id,\n        sloName: current.slo.name,\n        severity: current.state,\n        message: `SLO ${current.slo.name} is in ${current.state} state (${current.current.toFixed(2)}% vs target ${current.target}%)`,\n        current: current.current,\n        target: current.target,\n        errorBudget: current.errorBudget,\n        timestamp: new Date(),\n      };\n\n      await this.config.alertCallback(alert);\n    }\n  }\n\n  /**\n   * Default alert callback\n   */\n  private defaultAlertCallback(alert: SLOAlert): void {\n    const emoji = alert.severity === 'critical' ? 'ðŸš¨' : 'âš ï¸';\n    this.config.logger.error(\n      `${emoji} SLO ALERT [${alert.severity.toUpperCase()}] ${alert.message}`,\n      {\n        sloId: alert.sloId,\n        severity: alert.severity,\n        current: alert.current,\n        target: alert.target,\n        errorBudget: alert.errorBudget,\n      }\n    );\n  }\n\n  /**\n   * Get SLO summary report\n   */\n  getSummary(): {\n    total: number;\n    healthy: number;\n    warning: number;\n    critical: number;\n    avgErrorBudget: number;\n  } {\n    const statuses = this.getAllStatuses();\n    const total = statuses.length;\n    const healthy = statuses.filter(s => s.state === 'healthy').length;\n    const warning = statuses.filter(s => s.state === 'warning').length;\n    const critical = statuses.filter(s => s.state === 'critical').length;\n    const avgErrorBudget = statuses.length > 0\n      ? statuses.reduce((sum, s) => sum + s.errorBudget, 0) / statuses.length\n      : 100;\n\n    return {\n      total,\n      healthy,\n      warning,\n      critical,\n      avgErrorBudget,\n    };\n  }\n\n  /**\n   * Check if running\n   */\n  isRunning(): boolean {\n    return this.running;\n  }\n\n  /**\n   * Get configuration\n   */\n  getConfig(): Readonly<SLOManagerConfig> {\n    return Object.freeze({ ...this.config });\n  }\n}\n\n/**\n * Standard SLO Definitions\n */\nexport class StandardSLOs {\n  /**\n   * Availability SLO: % of successful requests\n   */\n  static availability(target = 99.9, windowSeconds = 3600): SLO {\n    return {\n      id: 'availability',\n      name: 'Availability',\n      description: `${target}% of requests should succeed`,\n      target,\n      window: windowSeconds,\n      metricQuery: async (registry) => {\n        // This is a simplified example. In production, you'd query actual metrics.\n        // For now, return a placeholder value.\n        return 99.95;\n      },\n    };\n  }\n\n  /**\n   * Latency SLO: % of requests below latency threshold\n   */\n  static latency(target = 95, thresholdMs = 1000, windowSeconds = 3600): SLO {\n    return {\n      id: 'latency',\n      name: 'Latency',\n      description: `${target}% of requests should complete within ${thresholdMs}ms`,\n      target,\n      window: windowSeconds,\n      metricQuery: async (registry) => {\n        // Placeholder\n        return 96.5;\n      },\n    };\n  }\n\n  /**\n   * Error Rate SLO: % of requests without errors\n   */\n  static errorRate(target = 99.5, windowSeconds = 3600): SLO {\n    return {\n      id: 'error_rate',\n      name: 'Error Rate',\n      description: `${target}% of requests should be error-free`,\n      target,\n      window: windowSeconds,\n      metricQuery: async (registry) => {\n        // Placeholder\n        return 99.7;\n      },\n    };\n  }\n}\n\n/**\n * Global SLO Manager (singleton pattern)\n */\nlet globalSLOManager: SLOManager | null = null;\n\nexport function initializeSLOManager(config: SLOManagerConfig): SLOManager {\n  if (globalSLOManager) {\n    console.warn('[SLOManager] Global instance already exists');\n    return globalSLOManager;\n  }\n\n  globalSLOManager = new SLOManager(config);\n  return globalSLOManager;\n}\n\nexport function getSLOManager(): SLOManager {\n  if (!globalSLOManager) {\n    throw new Error('[SLOManager] Global instance not initialized. Call initializeSLOManager() first.');\n  }\n  return globalSLOManager;\n}\n\nexport function shutdownSLOManager(): void {\n  if (globalSLOManager) {\n    globalSLOManager.stop();\n    globalSLOManager = null;\n  }\n}\n"],"mappings":"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","names":[]}